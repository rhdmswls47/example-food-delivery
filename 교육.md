git pull && git merge origin/template


리소스그룹 : user01-rsrcgrp / user01-aks_group
클러스터 : user01-aks
이미지 저장소 : user01

az login --use-device-code
az aks get-credentials --resource-group user01-rsrcgrp --name user01-aks
az aks get-credentials --resource-group user01-aks_group --name user01-aks

kubectl get all
kubectl get node

az aks update -n user01-aks -g user01-rsrcgrp --attach-acr user011
az aks update -n user01-aks -g user01-aks_group --attach-acr user01

docker build -t eunjin13/order:20240902 .

kubectl delete pod,deploy,svc --all
kubectl delete deployment,service --all -n tutorial

kubectl get deploy -o wide

kubectl create deploy home --image=eunjin13/welcome:v1
kubectl create deploy home --image=eunjin13/welcome:v1 -n eunjin13

kubectl get service -n istio-system

--클러스터ip로 변경
kubectl patch svc tracing -n istio-system -p '{"spec": {"type": "ClusterIP"}}'
--로드밸런서ip로 변경
kubectl patch service/istio-ingressgateway -n istio-system -p '{"spec": {"type": "LoadBalancer"}}'


4.218.10.243


az ad sp create-for-rbac --name user01-sp --role contributor --scopes /subscriptions/cb5860b7-b8db-408f-89c2-ca518893e315

{
  "appId": "ac3e2df3-61a6-4078-b2db-bfa33e54ab48",
  "displayName": "user01-sp",
  "password": "6Gq8Q~Knhfws.Mlr0--f-EKxMjl~jpTLr_uLvbCt",
  "tenant": "f46af6a3-e73f-4ab2-a1f7-f33919eda5ac"
}

http://4.218.10.243:8080/github-webhook/

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



--9/11 최종정리(?)

-구체적인 시나리오 필요(예매,포인트 어쩌구)
 해봤던 order product delivery 는 안됨
 예약서비스나 예매서비스는 가능
-이벤트스토밍은 영문으로
 바운디드컨텍스트 최소 4개 -CQRS(리드모델)도 컨텍스트 하나로 인정해줌
 이벤트와 폴리시는 1대1관계 약한결합으로 이어주기
 내부 릴레이션도 화살표 연결해주기!!
-이미지는 도커나 애저에..
-쿠버네티스 이름에 대문자있으면 안됨(바운디드컨텍스트)
-gitpod에서 git으로 push
-변경사항이 있어서 다시push하게되면 git의 main이 아닌 template 브랜치로 가게됨
 gitpod는 메인을 보게됨 pull&merge 명령어 복사해서 gitpod에 실행하면 merge됨
 gitpod에서 변경하게되면 소스컨트롤에서 staged하고 commit&push실행
-시나리오 구성 잘해야함
 saga패턴 (outofstock같은 상황을 만들어서 rollback 해야함)
-하나하나 캡쳐해서 증좌해야함(항목별로)
-HPA 오토스케일링(siege,,,임계치,,,) 
-컨테이너환경분리 --> configmap이나 secret 하나만 해보면됨. 응용.
-PVC스펙 캡처
-설정 & 결과 캡처 꼭!
-모니터링--> 추적 또는 로깅 또는 그라파나.. 했던거중에 하나만 보여주면됨

git pull && git merge origin/template

---------------------------------------------------------------------------------------------------------------------
ns 쓰기,,,-> 안써도됨

분산트랜잭션 - saga 전체적인 트랜잭션, 
보상처리 - compensation 품절일경우 invalid처리 , 시나리오랑 결과물에 있어야됨
CQRS - 리드모델 캡처 워킹한 증적 
컨테이너운영 - 배포하기 젠킨스 또는 애저
HPA - 마이크로서비스 하나에만 설정하면됨 자동으로 늘였다가줄였다가 /... 배포스펙에 리소스 스펙 있어야됨 - 마이크로서비스 확장과 오토 스케일아웃 랩 참조
configmap secret - helm설치해서 쓰는거중에 secret에 민감정보 저장하는 경우 있었음 , 설정 사용한결과 다 있어야함
PVC - ? 마운트패스 ?
셀프힐링 - 셀프힐링할 상황을 어케만들지?
서비스메시 - istio설정하고 내가 배포한 모든 POD에 분모가 2가된거 캡쳐

---------------------------------------------------------------------------------------------------------------------

시나리오

1. 고객이 예매하고 싶은 공연을 예매한다
2. 예매하면 티켓 금액의 5퍼센트를 포인트로 적립한다
3. 공연별 선착순 수량이 마감되면 해당 공연을 예매할 수 없다
4. 고객은 본인의 예매 이력을 볼 수 있다

status
예매대기? 예매완료 예매실패


http POST localhost:8083/tickets id=1 showId=1 showName="지킬앤하이드10월1일" stock=10 amount=150000
http POST localhost:8083/tickets id=2 showId=2 showName="지킬앤하이드10월2일" stock=20 amount=150000

http POST localhost:8082/reservations id=1 userId=1 showId=2 showName="지킬앤하이드10월2일" qty=2 amount=150000
http POST localhost:8082/reservations id=2 userId=1 showId=1 showName="지킬앤하이드10월1일" qty=11 amount=1650000
http POST localhost:8082/reservations id=3 userId=1 showId=1 showName="지킬앤하이드10월1일" qty=1 amount=150000

http POST localhost:8083/tickets id=3 reserveId=1 showId=1 showName="지킬앤하이드10월1일" stock=100 amount=150000

http POST localhost:8085/points id=1 point=0

http POST localhost:8080/reservations userid="value" showId="value" showName="value" qty="value" amount="value" reserveDt="value" status="value" 
http POST localhost:8080/tickets userid="value" showId="value" showName="value" qty="value" amount="value" reserveDt="value" status="value" 

repository().findById(Long.valueOf(ticketReserved.getQty())).ifPresent(ticket->{
            
            ticket.setStock(ticket.getStock() - ticketReserved.getQty()); // do something
            repository().save(ticket);


         });


docker-compose exec -it kafka /bin/bash
cd /bin

./kafka-console-consumer --bootstrap-server localhost:9092 --topic compensation --from-beginning
